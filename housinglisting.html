<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Housing Listings - Livio</title>
    <!-- Firebase and Firestore -->
    <!-- <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script> -->
    
    <!-- Bootstrap and other styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/nav.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            overflow-x: hidden;
        }

        .navbar {
            background-color: #001F3F;
        }

        .navbar.sticky-top {
            position: sticky;
            top: 0;
            z-index: 1020;
        }

        .nav-link {
            color: white !important;
        }

        .navbar-toggler-icon {
            background-color: white;
        }

        #search-section {
            background-color: #F1F5F9;
            padding: 60px 0;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 40px;
            background-image: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(250, 250, 250, 0.5));
        }

        h2 {
            font-weight: 600;
            color: #1E3A8A;
        }

        .form-control,
        .form-select {
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #1E3A8A;
            transition: all 0.3s ease-in-out;
        }

        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 8px rgba(30, 58, 138, 0.3);
        }

        .btn-primary {
            background-color: #1E3A8A;
            border-color: #1E3A8A;
            transition: all 0.3s ease-in-out;
        }

        .card {
            transition: all 0.4s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border: none;
            border-radius: 12px;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            color: #1E3A8A;
            font-weight: 600;
        }

        .rating {
            display: flex;
            align-items: center;
        }

        .rating i {
            color: #FFD700;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Livio</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="housinglisting.html">Housing Listing</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="findaroommate.html">Find A Roommate</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="expensesDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">Expenses</a>
                        <ul class="dropdown-menu" aria-labelledby="expensesDropdown">
                            <li><a class="dropdown-item" href="expense.html">Expenses</a></li>
                            <li><a class="dropdown-item" href="allexpenses.html">All Expenses</a></li>
                            <li><a class="dropdown-item" href="splitexpense.html">Split Expense</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="places.html">Places</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="profile.html">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Search Section -->
    <section id="search-section" class="py-5">
        <div class="container">
            <h2 class="text-center">Search Housing Listings</h2>
            <form id="search-form" class="row g-3 justify-content-center mt-4">
                <div class="col-md-4">
                    <select id="location" class="form-select">
                        <option selected value="">Select Location</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="number" id="maxPrice" class="form-control" placeholder="Max Price">
                </div>
                <div class="col-md-4">
                    <select id="roommateCount" class="form-select">
                        <option selected value="">Number of Roommates Allowed</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3+</option>
                    </select>
                </div>
                <div class="col-md-4 text-center">
                    <button type='submit' class='btn btn-primary'>Search</button>
                </div>
            </form>
        </div>
    </section>

    <!-- Listings Section -->
    <section id="listings" class="py-5 bg-white">
        <div class="container">
            <h2 class="text-center">Available Listings</h2>
            <div class="row mt-4 justify-content-center" id="listingsContainer"></div>
        </div>
    </section>

    <!-- Firebase Initialization and Firestore Functions -->
    <script type="module">

        // check if logged in
        if (localStorage.getItem("isLoggedIn") === null) window.location.href = "loginpage.html";

        // Add logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function () {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userFirstName');
            localStorage.removeItem('userLastName');
            window.location.href = 'loginpage.html';
        });

        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            getDocs,
            query,
            where,
            orderBy,
            doc,
            getDoc
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";


        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzWcOPasd5_KEcRodDRVtJA_wUn_-35N8",
            authDomain: "livio-e4af5.firebaseapp.com",
            databaseURL: "https://livio-e4af5-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "livio-e4af5",
            storageBucket: "livio-e4af5.appspot.com",
            messagingSenderId: "641180735040",
            appId: "1:641180735040:web:b95b1bcf4f53f4d519f1a5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);


        // Populate location dropdown function remains the same
        async function populateLocationDropdown() {
            const locationSelect = document.getElementById("location");
            try {
                const querySnapshot = await getDocs(collection(db, "rooms"));
                const locations = new Set();
                querySnapshot.forEach((doc) => {
                    const listing = doc.data();
                    if (listing.location) {
                        locations.add(listing.location);
                    }
                });
                locations.forEach(location => {
                    const option = document.createElement("option");
                    option.value = location;
                    option.textContent = location;
                    locationSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error fetching locations:", error);
            }
        }

        // Function to render stars based on rating
        function renderStars(rating) {
            rating = parseFloat(rating);
            let starsHTML = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= Math.floor(rating)) {
                    starsHTML += '<i class="fas fa-star"></i>';
                } else if (i - 0.5 <= rating) {
                    starsHTML += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    starsHTML += '<i class="far fa-star"></i>';
                }
            }
            return starsHTML;
        }

        // Function to fetch ratings for a specific listing
        async function fetchRatingForListing(listingNumber) {
            try {
                console.log(`Fetching ratings for houselisting${listingNumber}`);
                // Get ratings from the correct path: /feedbacks/feedback/houselisting{n}
                const ratingsRef = collection(db, 'feedbacks', 'feedback', `houselisting${listingNumber}`);
                const querySnapshot = await getDocs(ratingsRef);

                if (querySnapshot.empty) {
                    console.log(`No ratings found for houselisting${listingNumber}`);
                    return 0;
                }

                let totalRating = 0;
                let count = 0;

                querySnapshot.forEach(doc => {
                    const feedbackData = doc.data();
                    console.log('Rating data:', feedbackData);
                    if (feedbackData.rating) {
                        totalRating += parseFloat(feedbackData.rating);
                        count++;
                    }
                });

                if (count === 0) {
                    console.log('No valid ratings found in the documents');
                    return 0;
                }

                const averageRating = totalRating / count;
                console.log(`Calculated average rating: ${averageRating.toFixed(2)}`);
                return averageRating.toFixed(2);
            } catch (error) {
                console.error(`Error fetching ratings:`, error);
                console.error('Error details:', error.message);
                return 0;
            }
        }


        async function applyFilters(event) {
            event.preventDefault();
            const listingsContainer = document.getElementById("listingsContainer");
            listingsContainer.innerHTML = "";

            try {
                // Get reference to rooms collection
                const roomsRef = collection(db, "rooms");
                console.log("Fetching room listings...");

                const querySnapshot = await getDocs(roomsRef);
                console.log(`Found ${querySnapshot.size} listings`);

                if (querySnapshot.empty) {
                    listingsContainer.innerHTML = "<p>No listings available.</p>";
                    return;
                }

                // Apply filters
                const location = document.getElementById("location").value;
                const maxPrice = parseFloat(document.getElementById("maxPrice").value);
                const roommateCount = document.getElementById("roommateCount").value;

                // Process each listing
                for (const doc of querySnapshot.docs) {
                    const listing = { ...doc.data(), id: doc.id };
                    console.log("Processing listing:", listing);

                    // Skip if filters don't match
                    if (location && listing.location !== location) continue;
                    if (!isNaN(maxPrice) && listing.pricePerMonth > maxPrice) continue;
                    if (roommateCount) {
                        const countValue = roommateCount === "3+" ? 3 : parseInt(roommateCount);
                        if (listing.roommateCount < countValue) continue;
                    }

                    // Extract house number
                    let houseNumber;
                    if (listing.linkUrl) {
                        if (listing.linkUrl.includes('listing1.html')) houseNumber = '1';
                        else if (listing.linkUrl.includes('listing2.html')) houseNumber = '2';
                        else if (listing.linkUrl.includes('listing3.html')) houseNumber = '3';
                        else if (listing.linkUrl.includes('listing4.html')) houseNumber = '4';
                    }

                    if (houseNumber) {
                        console.log(`Found house number ${houseNumber} from linkUrl:`, listing.linkUrl);
                    } else {
                        console.log("No house number found in linkUrl:", listing.linkUrl);
                    }


                    const rating = await fetchRatingForListing(houseNumber);
                    const starRating = renderStars(parseFloat(rating));
                    const imageUrl = listing.imageUrl?.trim() || 'default-image.jpg';

                    const listingCard = `
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <img src="${imageUrl}" class="card-img-top" alt="Listing Image" style="height: 200px; object-fit: cover;">
                        <div class="card-body">
                            <h5 class="card-title">${listing.title}</h5>
                            <div class="rating mb-2">
                                ${starRating} 
                                <span class="ms-2">(${rating})</span>
                            </div>
                            <p>Location: ${listing.location || 'Not specified'}</p>
                            <p>Number of Roommates Allowed: ${listing.roommateCount || 'Not specified'}</p>
                            <p>Price: $${listing.pricePerMonth || 0}/month</p>
                            <p>Start Date: ${listing.startDate || 'Not specified'}</p>
                            <p>End Date: ${listing.endDate || 'Not specified'}</p>
                            <a href="${listing.linkUrl || '#'}" class="btn btn-outline-primary">View Details</a>
                        </div>
                    </div>
                </div>
            `;
                    listingsContainer.insertAdjacentHTML("beforeend", listingCard);
                    console.log("Added listing card for:", listing.title);
                }

                // If no listings were displayed after filtering
                if (listingsContainer.children.length === 0) {
                    listingsContainer.innerHTML = "<p>No listings match your search criteria.</p>";
                }

            } catch (error) {
                console.error("Error fetching room listings:", error);
                listingsContainer.innerHTML = "<p>Error loading listings. Please try again later.</p>";
            }
        }

        // Add event listeners
        document.getElementById('search-form').addEventListener('submit', applyFilters);
        window.addEventListener("load", () => {
            populateLocationDropdown();
            applyFilters(new Event('submit'));
        });


        console.log("Full listing data:", JSON.stringify(listing, null, 2));

    </script>

    <!-- ChatBot -->
    <script src="https://code.tidio.co/qo6vz8osrgu4gk4gqa6dmrpx1nvskwsq.js" async></script>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>